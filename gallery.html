<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gallery</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <script src="global-nav.js"></script>
    <script src="chatuser.js"></script>

    <main class="wrap">
        <section class="card">
            <div class="section-head">
                <div>
                    <h1>Gallery</h1>
                    <p class="muted">New work drops here first.</p>
                </div>
            </div>
        </section>

        <section class="card-soft section" aria-live="polite" id="galleryEmpty">
            <h2>No images yet</h2>
            <p class="muted">Check back soon for new shots. If you need access now, reach out.</p>
            <a class="btn" href="contact.html">Contact Mason</a>
        </section>
        <section class="grid section" id="galleryGrid" style="display:none" aria-label="gallery"></section>
        <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Image preview">
            <div>
                <img id="lightboxImg" alt="Gallery preview" />
                <div id="lightboxCaption" class="caption"></div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script>
        (async () => {
            const SUPABASE_URL = 'https://hyehyfbnskiybdspkbxe.supabase.co';
            const SUPABASE_ANON_KEY = 'sb_publishable_Spz2O3ITj_9Q7cT84pKG6w_2h4yOFyu';
            if (typeof supabase === 'undefined') return;
            const sb = window.msSupabase || (window.msSupabase = supabase.createClient(
                SUPABASE_URL,
                SUPABASE_ANON_KEY,
                { auth: { persistSession: true, autoRefreshToken: true, storageKey: 'mason_auth', storage: window.localStorage } }
            ));

            const grid = document.getElementById('galleryGrid');
            const empty = document.getElementById('galleryEmpty');
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightboxImg');
            const lightboxCaption = document.getElementById('lightboxCaption');

            async function loadGallery() {
                const { data } = await sb
                    .from('gallery_images')
                    .select('*')
                    .order('sort_order', { ascending: true })
                    .order('created_at', { ascending: true });
                if (!data || data.length === 0) {
                    grid.style.display = 'none';
                    empty.style.display = '';
                    return;
                }
                empty.style.display = 'none';
                grid.style.display = 'grid';
                grid.innerHTML = '';
                data.forEach((img) => {
                    const fig = document.createElement('figure');
                    fig.className = 'shot';
                    fig.innerHTML = `
                        <img src="${img.public_url}" alt="${img.caption || 'Gallery image'}" loading="lazy">
                        ${img.caption ? `<figcaption>${img.caption}</figcaption>` : ''}
                    `;
                    fig.addEventListener('click', () => {
                        if (!lightbox || !lightboxImg) return;
                        lightboxImg.src = img.public_url;
                        lightboxImg.alt = img.caption || 'Gallery image';
                        if (lightboxCaption) lightboxCaption.textContent = img.caption || '';
                        lightbox.classList.add('open');
                    });
                    grid.appendChild(fig);
                });
            }

            loadGallery();

            lightbox?.addEventListener('click', () => {
                lightbox.classList.remove('open');
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') lightbox?.classList.remove('open');
            });
        })();
    </script>
</body>
</html>
