<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mason Services — Pricing</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <script src="global-nav.js"></script>

  <main class="wrap" role="main">
    <section class="card">
    <header>
      <h1 id="pricingTitle">Mason — Pricing</h1>
      <p id="pricingSubtitle" class="muted">Low Quality Service, for a Low Low Price</p>
    </header>
    </section>

    <section id="pricingPlans" class="grid section" aria-label="pricing plans"></section>

    <section id="pricingCustom" class="card section">
      <h3 id="customTitle">Need a custom session?</h3>
      <p id="customBody" class="muted">Contact mason for volume discounts and enterprise offerings.</p>
      <a id="customCta" class="btn btn-dark" href="contact.html">Contact Sales</a>
    </section>
  </main>

  <!-- Supabase client (UMD) required by order.js and chat scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="order.js"></script>
  <script src="chatuser.js"></script>
  <script>
    (async () => {
      const SUPABASE_URL = 'https://hyehyfbnskiybdspkbxe.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_Spz2O3ITj_9Q7cT84pKG6w_2h4yOFyu';
      if (typeof supabase === 'undefined') return;
      const sb = window.msSupabase || (window.msSupabase = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY,
        { auth: { persistSession: true, autoRefreshToken: true, storageKey: 'mason_auth', storage: window.localStorage } }
      ));

      const titleEl = document.getElementById('pricingTitle');
      const subtitleEl = document.getElementById('pricingSubtitle');
      const plansEl = document.getElementById('pricingPlans');
      const customTitleEl = document.getElementById('customTitle');
      const customBodyEl = document.getElementById('customBody');
      const customCtaEl = document.getElementById('customCta');

      const fallbackPlans = [
        {
          title: 'Basic',
          price: '$2.50',
          price_subtitle: 'Per session',
          features: ['Will slap it around a bit', 'No bust is included'],
          cta_label: 'Book Basic',
          cta_plan: 'Basic',
          cta_amount: 2.5
        },
        {
          title: 'The "Happy Ending" Special',
          price: '$5',
          price_subtitle: 'Per Stroke',
          features: ['Mason will get it done QUICK!', 'Max 10 Strokes'],
          cta_label: 'Book Happy Ending',
          cta_plan: 'Standard',
          cta_amount: 10
        },
        {
          title: 'The "Finishing" Move',
          price: '$100',
          price_subtitle: 'Custom',
          features: ['Priority scheduling', 'Full Stroke Experience', 'Gauranteed Bust!'],
          cta_label: 'Book Finishing Move',
          cta_plan: 'Premium',
          cta_amount: 100
        }
      ];

      async function loadPricing() {
        try {
          const { data: pageData } = await sb
            .from('pricing_page_content')
            .select('*')
            .limit(1);
          if (pageData && pageData.length) {
            const page = pageData[0];
            if (page.title && titleEl) titleEl.textContent = page.title;
            if (page.subtitle && subtitleEl) subtitleEl.textContent = page.subtitle;
            if (page.custom_title && customTitleEl) customTitleEl.textContent = page.custom_title;
            if (page.custom_body && customBodyEl) customBodyEl.textContent = page.custom_body;
            if (page.custom_cta_label && customCtaEl) customCtaEl.textContent = page.custom_cta_label;
            if (page.custom_cta_url && customCtaEl) customCtaEl.setAttribute('href', page.custom_cta_url);
          }
        } catch (e) {}

        let plans = fallbackPlans;
        try {
          const { data } = await sb
            .from('pricing_plans')
            .select('*')
            .order('sort_order', { ascending: true })
            .order('created_at', { ascending: true });
          if (data && data.length) plans = data;
        } catch (e) {}

        if (!plansEl) return;
        plansEl.innerHTML = '';
        plans.forEach((plan) => {
          const card = document.createElement('article');
          card.className = 'card';
          const features = Array.isArray(plan.features)
            ? plan.features
            : String(plan.features || '').split('\n').filter(Boolean);
          card.innerHTML = `
            <h2>${plan.title}</h2>
            <div class="price">${plan.price}</div>
            <div class="muted">${plan.price_subtitle || ''}</div>
            <ul>${features.map((f) => `<li>${f}</li>`).join('')}</ul>
            <button class="cta place-order-btn" data-plan="${plan.cta_plan || plan.title}" data-amount="${plan.cta_amount || ''}" data-label="${plan.cta_label || 'Book'}">${plan.cta_label || 'Book'}</button>
          `;
          plansEl.appendChild(card);
        });
      }

      function playBookVideo() {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'ms-intro-video ms-book-video';
          overlay.innerHTML = `
            <video autoplay playsinline preload="auto">
              <source src="img/book.mp4" type="video/mp4" />
            </video>
          `;
          document.body.appendChild(overlay);
          const video = overlay.querySelector('video');
          const cleanup = () => {
            overlay.remove();
            resolve();
          };
          if (video) {
            video.muted = false;
            video.volume = 1;
            video.addEventListener('ended', cleanup);
            video.addEventListener('error', cleanup);
            video.addEventListener('click', cleanup);
            video.play().catch(() => {});
          }
          setTimeout(() => {
            if (overlay.isConnected) cleanup();
          }, 15000);
        });
      }

      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.place-order-btn');
        if (!btn) return;
        if (btn.dataset.bookVideoBypass === '1') {
          btn.removeAttribute('data-book-video-bypass');
          return;
        }
        e.preventDefault();
        e.stopImmediatePropagation();
        await playBookVideo();
        btn.setAttribute('data-book-video-bypass', '1');
        btn.click();
      }, true);

      loadPricing();
    })();
  </script>
</body>
</html>
