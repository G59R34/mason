<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contact Mason</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --accent:#0ea5a4;
      --ring:#e2e8f0;
    }
    body{
      margin:0;
      font-family:"Space Grotesk", system-ui, -apple-system, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 10% -10%, #dff7ff 0%, transparent 55%),
        radial-gradient(900px 600px at 110% -10%, #f2e9ff 0%, transparent 55%),
        linear-gradient(180deg,#eef6fb,#ffffff 45%,#f7f3ff);
    }
    .wrap{max-width:1100px;margin:36px auto 64px;padding:0 20px}
    .hero{background:#fff;border:1px solid var(--ring);border-radius:16px;padding:24px;box-shadow:0 18px 40px rgba(2,6,23,0.08)}
    h1{margin:0 0 6px;font-size:2.2rem}
    p{margin:0;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:18px}
    .card{background:#fff;border:1px solid var(--ring);border-radius:14px;padding:18px}
    label{display:block;font-size:0.9rem;color:var(--muted);margin:10px 0 6px}
    input[type="text"],textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:1rem;font-family:inherit}
    textarea{min-height:120px;resize:vertical}
    button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:#f1f5f9;border-radius:999px;font-size:0.95rem}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .note{font-size:0.9rem;color:var(--muted);margin-top:8px}
    .link{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <script src="global-nav.js"></script>
  <script src="chatuser.js"></script>

  <main class="wrap">
    <section class="hero">
      <h1>Contact Mason</h1>
      <p>Start a direct chat, or pick up where you left off.</p>
      <div class="pill" style="margin-top:12px">Fast response • Clear communication • No fluff</div>
    </section>

    <section class="grid">
      <div class="card">
        <h2>Start a chat</h2>
        <form id="startChatForm">
          <label for="name">Your name</label>
          <input id="name" name="name" type="text" placeholder="Name" required />
          <label for="message">Message</label>
          <textarea id="message" name="message" placeholder="Tell Mason what you need..." required></textarea>
          <div class="row" style="margin-top:10px">
            <button type="submit">Send & Open Chat</button>
            <span id="startChatStatus" class="muted"></span>
          </div>
        </form>
        <div class="note">This creates a conversation and opens your private thread.</div>
      </div>

      <div class="card">
        <h2>Resume a conversation</h2>
        <p class="muted">Use your saved conversation link or the ID below.</p>
        <form id="resumeForm" style="margin-top:10px">
          <label for="conversationId">Conversation ID</label>
          <input id="conversationId" name="conversationId" type="text" placeholder="e.g. 9c3b..." />
          <div class="row" style="margin-top:10px">
            <button type="submit">Open Conversation</button>
            <a id="resumeStored" class="link" href="#">Open saved conversation</a>
          </div>
        </form>
        <div id="storedHint" class="note"></div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    (async () => {
      const SUPABASE_URL = 'https://hyehyfbnskiybdspkbxe.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_Spz2O3ITj_9Q7cT84pKG6w_2h4yOFyu';
      const sb = window.msSupabase || (window.msSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, storageKey: 'mason_auth', storage: window.localStorage } }));

      const startForm = document.getElementById('startChatForm');
      const statusEl = document.getElementById('startChatStatus');
      const resumeForm = document.getElementById('resumeForm');
      const resumeStored = document.getElementById('resumeStored');
      const storedHint = document.getElementById('storedHint');

      const storedId = localStorage.getItem('ms_conversation_id');
      if (storedId) {
        storedHint.textContent = `Saved conversation found: ${storedId}`;
        resumeStored.href = `usertickets.html?conversation=${storedId}`;
      } else {
        storedHint.textContent = 'No saved conversation on this device yet.';
        resumeStored.style.display = 'none';
      }

      startForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = startForm.elements['name'].value.trim();
        const message = startForm.elements['message'].value.trim();
        if (!name || !message) return;
        statusEl.textContent = 'Sending...';

        const { data: cdata, error: cerr } = await sb
          .from('conversations')
          .insert([{ customer_name: name }])
          .select('id')
          .limit(1);

        if (cerr || !cdata || !cdata[0]) {
          statusEl.textContent = 'Could not create conversation.';
          return;
        }

        const conversationId = cdata[0].id;
        localStorage.setItem('ms_conversation_id', conversationId);
        localStorage.setItem('ms_customer_name', name);

        const { error: merr } = await sb
          .from('conversation_messages')
          .insert([{ conversation_id: conversationId, sender: name, body: message, sender_role: 'user' }]);

        if (merr) {
          statusEl.textContent = 'Conversation created, but message failed.';
          return;
        }

        window.location.href = `usertickets.html?conversation=${conversationId}`;
      });

      resumeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = (resumeForm.elements['conversationId'].value || '').trim();
        if (!id) return;
        window.location.href = `usertickets.html?conversation=${id}`;
      });
    })();
  </script>
</body>
</html>
