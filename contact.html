<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Contact Mason</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <script src="global-nav.js"></script>
  <script src="chatuser.js"></script>

  <main class="wrap">
    <section class="card">
      <h1>Contact Mason</h1>
      <p class="muted">Start a direct chat, or pick up where you left off.</p>
      <div class="pill" style="margin-top:12px">Fast response • Clear communication • No fluff</div>
    </section>

    <section class="grid section">
      <div class="card">
        <h2>Start a chat</h2>
        <form id="startChatForm" class="form">
          <label for="name">Your name</label>
          <input id="name" name="name" type="text" placeholder="Name" required />
          <label for="message">Message</label>
          <textarea id="message" name="message" placeholder="Tell Mason what you need..." required></textarea>
          <div class="row" style="margin-top:10px">
            <button type="submit">Send & Open Chat</button>
            <span id="startChatStatus" class="muted"></span>
          </div>
        </form>
        <div class="muted" style="margin-top:8px">This creates a conversation and opens your private thread.</div>
      </div>

      <div class="card">
        <h2>Resume a conversation</h2>
        <p class="muted">Use your saved conversation link or the ID below.</p>
        <form id="resumeForm" class="form" style="margin-top:10px">
          <label for="conversationId">Conversation ID</label>
          <input id="conversationId" name="conversationId" type="text" placeholder="e.g. 9c3b..." />
          <div class="row" style="margin-top:10px">
            <button type="submit">Open Conversation</button>
            <a id="resumeStored" href="#">Open saved conversation</a>
          </div>
        </form>
        <div id="storedHint" class="muted" style="margin-top:8px"></div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    (async () => {
      const SUPABASE_URL = 'https://hyehyfbnskiybdspkbxe.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_Spz2O3ITj_9Q7cT84pKG6w_2h4yOFyu';
      const sb = window.msSupabase || (window.msSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, storageKey: 'mason_auth', storage: window.localStorage } }));

      const startForm = document.getElementById('startChatForm');
      const statusEl = document.getElementById('startChatStatus');
      const resumeForm = document.getElementById('resumeForm');
      const resumeStored = document.getElementById('resumeStored');
      const storedHint = document.getElementById('storedHint');

      const storedId = localStorage.getItem('ms_conversation_id');
      if (storedId) {
        storedHint.textContent = `Saved conversation found: ${storedId}`;
        resumeStored.href = `usertickets.html?conversation=${storedId}`;
      } else {
        storedHint.textContent = 'No saved conversation on this device yet.';
        resumeStored.style.display = 'none';
      }

      startForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = startForm.elements['name'].value.trim();
        const message = startForm.elements['message'].value.trim();
        if (!name || !message) return;
        statusEl.textContent = 'Sending...';

        const { data: cdata, error: cerr } = await sb
          .from('conversations')
          .insert([{ customer_name: name }])
          .select('id')
          .limit(1);

        if (cerr || !cdata || !cdata[0]) {
          statusEl.textContent = 'Could not create conversation.';
          return;
        }

        const conversationId = cdata[0].id;
        localStorage.setItem('ms_conversation_id', conversationId);
        localStorage.setItem('ms_customer_name', name);

        const { error: merr } = await sb
          .from('conversation_messages')
          .insert([{ conversation_id: conversationId, sender: name, body: message, sender_role: 'user' }]);

        if (merr) {
          statusEl.textContent = 'Conversation created, but message failed.';
          return;
        }

        window.location.href = `usertickets.html?conversation=${conversationId}`;
      });

      resumeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = (resumeForm.elements['conversationId'].value || '').trim();
        if (!id) return;
        window.location.href = `usertickets.html?conversation=${id}`;
      });
    })();
  </script>
</body>
</html>
