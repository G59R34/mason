<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Mason</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <script src="global-nav.js"></script>
    <script src="chatuser.js"></script>
   
    <main class="wrap">
        <section class="card hero">
            <div class="hero-content">
              
                <h1>Hello, I'm Mason.</h1>
                <p>Book a private session and I will FUCK you.</p>
                <div class="hero-actions">
                    <a class="btn" href="pricing.html">Book a session</a>
                    <a class="btn btn-ghost" href="reviews.html">See reviews</a>
                    <a class="btn btn-ghost" href="forums.html">Open forums</a>
                </div>
                <div class="stats-grid section">
                    <div class="stat-card"><strong>Slow replies</strong>Most clients hear back within a month.</div>
                    <div class="stat-card"><strong>Foggy Inconsistent scheduling</strong>Everything is confirmed at some point.</div>
                    <div class="stat-card"><strong>Private chat</strong>Secure, real-time updates on you FUCK session.</div>
                </div>
            </div>
            <div class="hero-media">
                <img src="/img/mason.png" alt="Mason">
            </div>
        </section>

        <section class="section">
            <div class="section-head">
                <h2>Recent reviews</h2>
                <a href="reviews.html">View all</a>
            </div>
            <div id="recentReviews" class="grid">
                <div class="card-soft muted">Loading reviews...</div>
            </div>
        </section>

        <section class="section card" aria-label="mason quote">
            <div class="section-head">
                <h2>From Mason</h2>
            </div>
            <blockquote class="quote">
                You WILL get FUCKED
            </blockquote>
        </section>
    </main>
    <script>
        (async () => {
            const SUPABASE_URL = 'https://hyehyfbnskiybdspkbxe.supabase.co';
            const SUPABASE_ANON_KEY = 'sb_publishable_Spz2O3ITj_9Q7cT84pKG6w_2h4yOFyu';

            if (typeof supabase === 'undefined') {
                await new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js';
                    s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
                }).catch(() => {});
            }
            if (typeof supabase === 'undefined') return;

            const sb = window.msSupabase || (window.msSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, storageKey: 'mason_auth', storage: window.localStorage } }));
            const list = document.getElementById('recentReviews');
            if (!list) return;

            async function loadRecentReviews() {
                let data = null;
                let error = null;
                {
                    const res = await sb
                        .from('reviews')
                        .select('name, comment, rating, created_at, verified, owner')
                        .order('created_at', { ascending: false })
                        .limit(3);
                    data = res.data;
                    error = res.error;
                }
                if (error) {
                    const fallback = await sb
                        .from('reviews')
                        .select('name, comment, rating, created_at')
                        .order('created_at', { ascending: false })
                        .limit(3);
                    data = fallback.data;
                    error = fallback.error;
                }

                if (error || !data || data.length === 0) {
                    list.innerHTML = '<div class=\"review-empty\">No reviews yet.</div>';
                    return;
                }

                list.innerHTML = '';
                data.forEach(r => {
                    const card = document.createElement('div');
                    card.className = 'review-card';
                    const meta = document.createElement('div');
                    meta.className = 'review-meta';
                    const verified = !!(r.verified || r.owner);
                    meta.innerHTML = `<span>${r.name || 'Anonymous'}</span>${verified ? '<span class=\"verified-badge\">VERIFIED</span>' : ''}<span class=\"review-stars\">${r.rating || 0}â˜…</span>`;
                    const text = document.createElement('div');
                    text.className = 'review-text';
                    const comment = (r.comment || '').trim();
                    text.textContent = comment.length > 140 ? comment.slice(0, 137) + '...' : comment;
                    card.appendChild(meta);
                    card.appendChild(text);
                    list.appendChild(card);
                });
            }

            await loadRecentReviews();

            try {
                sb.channel('public:reviews')
                  .on('postgres_changes', { event: '*', schema: 'public', table: 'reviews' }, () => {
                      loadRecentReviews();
                  })
                  .subscribe();
            } catch (e) { console.warn('reviews realtime failed', e); }
        })();
    </script>
</body>
</html>
